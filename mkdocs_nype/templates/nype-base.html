{% extends "base.html" -%}

{# Define a nype_config dict for the current page, instead of working with the global reference -#}
{# Defined in the outer scope to allow every block to access it -#}
{% set page_nype_config = { 'js': {} } -%}
{% set theme_nype_config = config.theme.nype_config or {} -%}

{# Set a shortform handle for the conditionals below #}
{% set has_meta_config = page.meta and page.meta.nype_config -%}
{% if has_meta_config -%}
    {% set meta_config = page.meta.nype_config -%}
{% endif -%}

{% block styles -%}
    {{- super() -}}
    {#- nype-main.css should come after material to allow for parent theme overrides.
        The extra.css styles are loaded later, so nype-main.css can be overridden too. -#}
    <link rel="stylesheet" href="{{ 'assets/stylesheets/nype-main.css' | url }}">
{%- endblock %}

{% block extrahead -%}
    {#- Load global values into the local dict. Skip 'js' to not copy a reference -#}
    {% for name, value in theme_nype_config.items() -%}
        {% if name != 'js' -%}
            {% set _ = page_nype_config.update({ name: value }) -%}
        {% endif -%}
    {% endfor -%}

    {#- Load JavaScript separately to create new memory references -#}
    {% if theme_nype_config.js -%}
        {% for name, value in theme_nype_config.js.items() -%}
            {% set _ = page_nype_config.js.update({ name.lower(): value }) -%}
        {% endfor -%}
    {% endif -%}

    {# Incldue global 'non-js' values in the js of the current page #}
    {% if has_meta_config and meta_config.js_include -%}
        {% for name in meta_config.js_include -%}
            {% set value = page_nype_config.get(name.lower()) %}
            {% if not value and {}.__getitem__('ERROR: The value for page_nype_config.' ~ name ~ ' is undefined') %}
            {% endif %}
            {% set _ = page_nype_config.js.update({ name.lower(): value })-%}
        {% endfor -%}
    {% endif %}
    
    {#- Pass the config from the page meta to JavaScript with lowercase variables. 
        Allows to override global values per page. -#}
    {% if has_meta_config and meta_config.js -%}
        {% for name, value in meta_config.js.items() -%}
            {%- set _ = page_nype_config.js.update({ name.lower(): value })-%}
        {% endfor -%}
    {% endif -%}
    <script>
        const nypeScriptConfig = JSON.parse('{{ page_nype_config.js | tojson }}');
    </script>
{%- endblock %}

{% block header -%}
    {#- Custom helper div to use for CSS selector in extra.css -#}    
    {% if page and page.file.dest_uri == "index.html" -%}
        {% set page_variant = 'nype-home-page' -%}
    {%- elif posts -%}
        {% set page_variant = 'nype-blog-page' -%}
    {%- else -%}
        {% set page_variant = 'nype-normal-page' -%}
    {%- endif -%}

    <style class="nype-header-styles {{ page_variant }}"></style>

    {{- super() -}}

    {#- Pass the config from the page meta to the CSS styles. Opt-in approach. -#}
    {% set container_ns = namespace(css='') -%}
    {% if has_meta_config and meta_config.container_css -%}
        {% for css_name in meta_config.container_css.strip().split(' ') %}
            {% set container_ns.css = container_ns.css ~ ' nype-' ~ css_name -%}
        {% endfor %}
    {% endif -%}

    <style class="nype-container-styles{{ container_ns.css }}"></style>

    {#- Update page.meta to hide side panels -#}
    {% if 'content-only' in container_ns.css -%}
        {% set _ = page.meta.update({ 'hide': ['navigation', 'toc']}) %}
    {%- endif -%}
{%- endblock %}

{% block scripts -%}
    {#- nype-core.js should come before extra.js in projects. In case nype-core.js needs access 
        to material bundle.js then some solution will need to be implemented TODO -#}
    <script src="{{ 'assets/javascripts/nype-core.js' | url }}"></script>
    {{- super() -}}
{% endblock %}